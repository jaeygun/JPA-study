# 영속성
## 1. 엔티티 매니저 팩토리와 엔티티 매니저
엔티티 매니저는 엔티티를 저장, 수정, 삭제하는 등 엔티티와 관련된 모든 일을 처리하게 된다. 엔티티 매니저 팩토리란 방금 말한 엔티티 매니저를 생성하는 역활을 하게 된다.

#### 1) 엔티티 매니저 팩토리 생성
데이터베이스를 하나만 사용하는 서비스의 경우 엔티티 매니저 팩토리는 1개만 생성하게 된다.
```Java
EntityManagerFactory emf = Persistence.createEntityManagerFactory("jpatest");
```
위의 코드를 호출하면 저장된 jdbc정보를 바탕으로 엔티티 매니저 팩토리가 생성이 된다.

#### 2) 엔티티 매니저 생성
```Java
EntityManager em = emf.createEntityManager();
```

하나의 엔티티 매니저 팩토리는 여러 엔티티 매니저를 만들 수 있는데, 엔티티 매니저는 생성되더라고 데이터데이스 연결이 필요하기 전까지는 커넥션을 얻지 않는다. 

<br/>

## 2. 영속성 컨텍스트(persistence context)란?
영속성 컨텍스트란 엔티티들이 저장되는 공간이다. 엔티티 매니저로 엔티티를 저장하거나 조회하면 엔티티 메니저는 영속성 컨텍스트 안에 엔티티를 저장하고 관리한다.

```Java
em.persist(member);
```
member 엔티티를 저장한다고 많이 사용했던 위의 코드는 정확히 말하면 **엔티티 매니저가 영속성 컨텍스트에 member엔티티를 저장**한다는 의미이다.

#### 1) 엔티티의 생명주기
엔티티의 생명주기는 아래와 같이 4가지가 있다.
1. 영속 &rightarrow; 영속성 컨텍스트에 저장된 상태.
2. 비영속 &rightarrow; 영속성 컨텍스트와 관련이 없는 상태.
3. 준영속 &rightarrow; 영속성 컨텍스트에 저장되었다가 분리된 상태.
4. 삭제 &rightarrow; 영속성 컨텍스트에서 삭제된 상태.

#### 1-1) 영속
```Java
em.persist(member);
```
위의 코드는 엔티티 매니저를 통해 member엔티티가 영속성 컨텍스트에 저장된 상태이다. 그럼 member엔티티는 **영속**된 상태이다.

#### 1-2) 비영속
```Java
Member member = new Member();
member.setId("test");
member.setName("홍길동");
```
위의 코드는 member엔티티를 생성했지만 저장되지 않은 순수 객체의 상태이다. 지금 member엔티티는 **비영속**된 상태이다.

#### 1-3) 준영속
```Java
em.detch(member);
```
member 엔티티는 위의 코드로 인해 영속성 컨텍스트에서 분리된 **준영속**상태가 되었다. 
`em.close();`, `em.clear();` 처럼 영속성 컨텍스트를 닫아버리거나, 초기화를 해도 영속성 컨텍스트가 관리하던 영속 상태의 엔티티는 준영속 상태가 되어버린다. 

#### 1-4) 삭제
```Java
em.remove(member);
```
member 엔티티가 영속성 컨텍스트와 데이터베이스에서 **삭제**되었다.

<br/>

## 3. 영속성 컨텍스트의 특징